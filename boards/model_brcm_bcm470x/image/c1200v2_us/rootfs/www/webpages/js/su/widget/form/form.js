(function($){$.su.Widget("form",{defaults:{fields:[],proxy:null,formEnctype:"application/x-www-form-urlencoded",traditional:false,hiddenFrame:false,submitBtn:null,autoLoad:true,showPrompt:true,sendDisableData:false,promptTextSuccessed:$.su.CHAR.OPERATION.FORM_SAVED,promptTextFailed:$.su.CHAR.OPERATION.FORM_FAILED,cls:""},create:function(defaults,options){var me=this;me.each(function(i,obj){var tar=$(obj).addClass("form-panel");$.extend(obj,defaults,options);obj.id=obj.id||$.su.randomId("form");var proxy=obj.proxy;if(proxy){if(!proxy.isProxy){proxy=new $.su.Proxy(proxy)}obj.proxy=proxy}var method="POST",action="",target=obj.hiddenFrame?"_"+obj.id+"_iframe":"_self";if(obj.proxy){method=obj.proxy.writer.type;action=obj.proxy.writer.url}if(!tar.is("form")){var form=$('<form enctype="'+obj.formEnctype+'" method="'+method+'" action="'+action+'" target="'+target+'"></form>');form.append(tar.children().detach());tar.append(form)}else{tar.attr("enctype",obj.formEnctype);tar.attr("method",method);tar.attr("action",action);tar.attr("target",target)}tar.addClass(obj.cls);if(obj.hiddenFrame){var iframe=$('<iframe id="'+target+'" name="'+target+'" class="hidden"></iframe>');iframe.insertAfter(tar)}var inHTML="";if(obj.submitBtn){inHTML+='<div class="form-submit button-container submit">';inHTML+='<span class="form-error-tips error"></span>';inHTML+='<div class="form-submit-wrap"></div>';inHTML+='<span class="loading"></span>';inHTML+="</div>"}inHTML+='<div class="form-prompt successed">';inHTML+='<div class="bg"></div>';inHTML+='<div class="content">';inHTML+='<span class="icon"></span>';inHTML+='<span class="text text-successed">'+obj.promptTextSuccessed+"</span>";inHTML+='<span class="text text-failed">'+obj.promptTextFailed+"</span>";inHTML+="</div>";inHTML+="</div>";var formPrompt=$(inHTML);tar.append(formPrompt);obj.isForm=true;if(obj.isPanel){obj.isFormPanel=true}if(obj.autoLoad){tar.form("load")}if(obj.submitBtn){var type=$.type(obj.submitBtn),submitBtn=null;if(type==="string"){if(obj.submitBtn==="default"){submitBtn=$('<button type="button"></button>').button({text:$.su.CHAR.OPERATION.SAVE,cls:"submit",handler:function(e){me.trigger("beforeSubmit");me.form("submit",{},obj.callback)}})}else{submitBtn=$(obj.submitBtn);if(submitBtn.length==0){}}}else{if(obj.submitBtn.isButton){submitBtn=$(obj.submitBtn)}else{}}obj.submitBtn=submitBtn.get(0);if(obj.submitBtn&&obj.submitBtn.isButton){tar.find("div.form-submit-wrap").append(submitBtn.button("getContainer"))}else{tar.find("div.form-submit-wrap").append(submitBtn)}}});var proxy=$(me.get(0).proxy);proxy.on("ev_read",function(e,result,status,xhr){me.form("hideLoading");me.form("loadData",result)}).on("ev_write",function(e,result,status,xhr){me.form("hideLoading");me.form("loadData",result)}).on("ev_failed",function(e,errorcode,others,data){me.form("hideLoading");me.trigger("ev_failed",[me,errorcode,others,data])});me.on("ev_validatechange",function(e,result,fg){e.stopPropagation();if(result==true){me.form("setNormal")}});return me},validate:function(me){var me=me||this,obj=me.get(0),fields=obj.fields,result=true,fg=null;me.form("setNormal");$("div.widget-error-tips-wrap").css("display","none");for(var index=0;index<fields.length;index++){var field=fields[index];if(field){var name=field.name,mapping=field.mapping||name;if(name){var input=me.find("[name="+name+"]");if(input.length!=0){var xtype=input.get(0).xtype;if(xtype){if(!input[xtype]("getContainer").hasClass("disabled")&&(!input.prop("disabled")||xtype=="combobox")){if(input[xtype]("validate")){var inputObj=input.get(0);var v=input[xtype]("getValue");if(inputObj.textFormat){input[xtype]("setValue",inputObj.textFormat(v))}continue}else{result=false;fg=input.attr("id");break}}}}}}}if(result){if(obj.validator&&$.type(obj.validator)==="function"){result=obj.validator.call(me);if(!result){me.find("div.error input.text-text").each(function(i,errorObj){var errorContainer=$(errorObj).closest("div");errorContainer.delegate("input.text-text","click",function(e){e.stopPropagation();me.find(".form-error-tips").css("display","none")})})}fg="validator"}}me.triggerHandler("ev_validatechange",[result,fg]);return result},doSubmit:function(me,params){var me=me||this,obj=me.get(0),form=me.is("form")?me:me.find("form");var traditional=obj.traditional,proxy=me.form("getProxy"),param=params[1]||{},callback=params[2]||null,callback_failed=params[3]||null,callback_error=params[4]||null,showPrompt=(params[5]!==undefined)?params[5]:obj.showPrompt;if(traditional){var input=null;for(var index in param){input=form.find("[name="+index+"]");if(input.length){input.val(param[index])}else{input=$('<input type="hidden" class="hidden" name="'+index+'" value="'+param[index]+'"/>');form.append(input)}}form.submit();var iframe=$("#"+$(form).attr("target"));var form_id=$(form).attr("target");iframe.one("load",function(){var doc;try{doc=document.getElementById(form_id).contentDocument.body.textContent||document.getElementById(form_id).contentDocument.body.innerHTML}catch(error){}if(proxy){var data=!doc?"":$.su.json.parseJSON(doc);if(typeof(data)=="object"){if(data.success){proxy.callbackSuccess(data,callback)}else{proxy.callbackFail(data,callback_failed)}}else{proxy.callbackError(callback_error)}}});return}me.form("showLoading");var data=me.form("serialize");if(proxy){proxy.write($.extend({},data,param),function(data,others,status,xhr){me.form("hideLoading");if(showPrompt){me.form("prompt",true)}if(callback){callback.call(me,data,others,status,xhr)}},function(errorcode,others,data){me.form("hideLoading");if(showPrompt){if(errorcode!="permission denied"&&errorcode!="user conflict"){me.form("prompt",false)}}if(callback_failed){callback_failed.call(me,errorcode,others,data)}},function(xhr,status,type){me.form("hideLoading");if(showPrompt){me.form("prompt",false)}if(callback_error){callback_error.call(me,xhr,status,type)}})}},submit:function(me,params){var me=me||this,obj=me.get(0),form=me.is("form")?me:me.find("form"),traditional=obj.traditional,proxy=me.form("getProxy"),param=params[1]||{},callback=params[2]||null,callback_failed=params[3]||null,callback_error=params[4]||null,showPrompt=(params[5]!==undefined)?params[5]:obj.showPrompt,doValidate=params[6]===false?false:true;if(doValidate!==false){if(!me.form("validate")){return false}}me.form("doSubmit",param,callback,callback_failed,callback_error,showPrompt,doValidate)},load:function(me,params){var me=me||this;var proxy=me.get(0).proxy;if(proxy){proxy.read()}},loadData:function(me,params){var me=me||this,data=params[1]||[],fields=me.get(0).fields;me.trigger("ev_beforeLoadData",data);me.data("data",data);for(var index=0;index<fields.length;index++){var field=fields[index];if(field){var name=field.name,mapping=field.mapping||name;if(name){var obj=me.find("[name="+name+"]");if(obj.length!=0){var xtype=obj.get(0).xtype;if(xtype){var dd=data[mapping];if(dd!==undefined){obj[xtype]("setValue",dd)}else{continue}}}}}}me.trigger("ev_loadData",data)},getProxy:function(me){var me=me||this,proxy=me.get(0).proxy;if(proxy&&proxy.isProxy){return proxy}else{return null}},serialize:function(me){var me=me||this,form=me.is("form")?me:me.find("form");var disabled=me.get(0).sendDisableData?form.find(":input:disabled").removeAttr("disabled"):$();var serializeArray=form.serializeArray(),params={};disabled.attr("disabled","disabled");for(var index=0;index<serializeArray.length;index++){var serializeObj=serializeArray[index],name=serializeObj.name,value=serializeObj.value;params[name]=value}return params},reset:function(me){var me=me||this,obj=me.get(0),fields=obj.fields;for(var index=0;index<fields.length;index++){var field=fields[index];if(field){var name=field.name,mapping=field.mapping||name;if(name){var input=me.find("[name="+name+"]");if(input.length!=0){var xtype=input.get(0).xtype;if(xtype){input[xtype]("reset")}}}}}me.trigger("ev_reset");return me},prompt:function(me,params){var me=me||this,obj=me.get(0),buttonContainer=me.find("div.form-submit"),showPrompt=me.get(0).showPrompt,successed=params[1],text=params[2],time=params[3]||900,formPrompt=me.find("div.form-prompt");if(successed){formPrompt.removeClass("failed").addClass("successed");text=text||obj.promptTextSuccessed;formPrompt.find("span.text-successed").html(text)}else{formPrompt.removeClass("successed").addClass("failed");text=text||obj.promptTextFailed;formPrompt.find("span.text-failed").html(text)}var pH=formPrompt.outerHeight(),pW=formPrompt.outerWidth(),fH=me.innerHeight()-buttonContainer.height(),fW=me.innerWidth()-buttonContainer.height();var l=parseInt((fW-pW)/2,10);var t=parseInt((fH-pH)/2,10);formPrompt.css({left:l,top:t});formPrompt.fadeIn("150",function(){setTimeout(function(){formPrompt.fadeOut("150")},time)});return me},getContainer:function(me){var me=me||this;return me},setError:function(me,tips){var me=me||this;var tips=tips[1];if(tips){var tipContaienr=me.find("span.form-error-tips");tipContaienr.html(tips).fadeIn(150)}return me},setNormal:function(me){var me=me||this,obj=me.get(0),fields=obj.fields;for(var index=0;index<fields.length;index++){var field=fields[index];if(field){var name=field.name,mapping=field.mapping||name;if(name){var input=me.find("[name="+name+"]");if(input.length!=0){var xtype=input.get(0).xtype;if(xtype){input[xtype]("setNormal")}}}}}var tipContaienr=me.find("span.form-error-tips");tipContaienr.css("display","none");return me},showLoading:function(me){var me=me||this,obj=me.get(0),submitBtn=$(obj.submitBtn);submitBtn.button("disable");submitBtn.closest("div.form-submit").find("span.loading").fadeIn(50);return me},hideLoading:function(me){var me=me||this,obj=me.get(0),submitBtn=$(obj.submitBtn);submitBtn.button("enable");submitBtn.closest("div.form-submit").find("span.loading").fadeOut(50);return me},enable:function(me,callback){var me=me||this,obj=me.get(0),submitBtn=$(obj.submitBtn),fields=obj.fields,callback=callback[1];for(var index=0,len=fields.length;index<len;index++){var field=fields[index];if(field){var name=field.name;var tar=me.find('[name="'+name+'"]');if(tar.length>0){var xtype=tar.get(0).xtype;if(xtype&&(tar.prop("inFront")!="no")){tar[xtype]("enable")}}}}if(submitBtn.length>0){submitBtn.button("enable")}if(callback){callback.call(me)}return me},disable:function(me,callback){var me=me||this,obj=me.get(0),submitBtn=$(obj.submitBtn),fields=obj.fields,callback=callback[1];for(var index=0,len=fields.length;index<len;index++){var field=fields[index];if(field){var name=field.name;var tar=me.find('[name="'+name+'"]');if(tar.length>0){var xtype=tar.get(0).xtype;if(xtype&&(tar.prop("inFront")!="no")){tar[xtype]("disable")}}}}if(submitBtn.length>0){submitBtn.button("disable")}if(callback){callback.call(me)}return me}})})(jQuery);